name: Auto Merge WishWall PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  automerge-wishwall:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ“‚ è·å–æœ¬æ¬¡ PR æ”¹åŠ¨çš„æ–‡ä»¶åˆ—è¡¨
        id: filecheck
        run: |
          echo "ğŸ“‚ æ­£åœ¨è·å–æœ¬æ¬¡ PR æ”¹åŠ¨çš„æ–‡ä»¶åˆ—è¡¨..."
          echo "FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path')" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” åˆ¤æ–­æ˜¯å¦ä»…ä¿®æ”¹äº† wishwall æ–‡ä»¶
        id: judge
        run: |
          echo "ğŸ” å¼€å§‹æ£€æŸ¥æ˜¯å¦åªæ”¹åŠ¨äº† src/main/resources/è®¸æ„¿å¢™.xlsx ..."
          if [ "$(echo "$FILES" | wc -l)" = "1" ] && [[ "$FILES" == "src/main/resources/è®¸æ„¿å¢™.xlsx" ]]; then
            echo "âœ… ä»…ä¿®æ”¹äº†è®¸æ„¿å¢™ï¼Œå‡†å¤‡åˆå¹¶ PR"
            echo "should_merge=true" >> $GITHUB_ENV
          else
            echo "âŒ ä¿®æ”¹äº†å…¶ä»–æ–‡ä»¶ï¼Œä¸è¿›è¡Œè‡ªåŠ¨åˆå¹¶"
            echo "should_merge=false" >> $GITHUB_ENV
          fi

      - name: ğŸ¤– è‡ªåŠ¨åˆå¹¶ PRï¼ˆä»…é™ wishwall æ–‡ä»¶ï¼‰
        if: env.should_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log("ğŸ¤– æ­£åœ¨è‡ªåŠ¨åˆå¹¶ PR... âœ…");
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: "merge"
            });
            console.log("ğŸ‰ PR åˆå¹¶æˆåŠŸï¼");
